#! /usr/bin/env perl

#-----------------------------------------------------------------------------
# POD Format Documentation.  Read "perldoc perlpod" for an example.
# When done, check syntax with "podchecker".

=head1 NAME

testit - A little test driver.

=head1 SYNOPSIS

testit [--help] --no-fatal [--just tcname] [--optimize] [--no-debug] [--clean] [--outdir dir] [--driverpath dir] [--lldebug]

=head1 DESCRIPTION

This used to be the testsuite, but now just for easy running a specific test manually.  The testsuite orchestration has been (mostly) moved to ctest.

Options:

=over 4

=item --driverpath dir

Where to run silly from.

=item --outdir dirname

Will be created with 'mkdir -p' if it doesn't exist.

=item --no-fatal

Warn, insted of die, on error.

=item --just testname

Run only testname.  Given full source test.silly, say, this is the test file stem test.

=item --no-debug

Do not pass -g to compiler.

=item --optimize

Pass -O 2 to compiler.

=item --lldebug

Pass the llvm/mlir --debug option to the silly driver.

=back

=head1 SUPPORTED PLATFORMS

 Unix (Linux verified)

=head1 SUPPORT

 Send email to peeterjoot@pm.me

=head1 AUTHORS

 Peeter Joot

=cut

#-----------------------------------------------------------------------------

use strict ;
use warnings ;
use Getopt::Long ;
use Pod::Usage ;

# Suppress sourcing of users' .bashrc files in invoked shells
delete $ENV{'ENV'} ;
delete $ENV{'BASH_ENV'} ;

# Set STDOUT and STDERR to unbuffered
select STDERR ; $| = 1 ;
select STDOUT ; $| = 1 ;

my $myName = '' ;

($myName = $0) =~ s@.*[/\\]@@ ;
my $fatal = 1;
my $just;
my $optimize = 0;
my $debug = 1;
my $lldebug = 0;
my $clean = 0;
my $assembly = 1;
my $outdir;
my $driverpath;

#Getopt::Long::Configure( 'pass_through' ) ;
GetOptions (
   'help'               => sub { pod2usage(-verbose => 2) ; },
   'fatal!'             => \$fatal,
   'just=s'             => \$just,
   'outdir=s'           => \$outdir,
   'driverpath=s'       => \$driverpath,
   'optimize!'          => \$optimize,
   'assembly!'          => \$assembly,
   'debug!'             => \$debug,
   'lldebug!'           => \$lldebug,
   'clean!'             => \$clean,
) or pod2usage(-verbose => 0) ;

# Validate/handle options, and everything else...

# normalize input:
if ( defined $just )
{
    $just =~ s/\.silly$//;
    $just =~ s/\.sir$//;
}

if ( !defined $driverpath )
{
    my $TOP = `git rev-parse --show-toplevel 2>/dev/null`; chomp $TOP;
    $driverpath = "${TOP}/build/bin";
}

my $flags = '';

if ( $optimize )
{
    $flags .= ' -O 2';
}

if ( $debug )
{
    $flags .= ' -g';
}

if ( $lldebug )
{
    $flags .= ' --debug';
}

if ( !defined $outdir )
{
    $outdir = 'out'
}

if ( $clean )
{
    verbose_system( qq(rm -rf $outdir) );
}

my %tests = ();

die if ( !defined $just ); # now required.

$tests{$just}++ unless ( defined $tests{$just} );

my @warnings = ();

sub verbose_system
{
    my ($cmd) = @_;

    print "# $cmd\n";
    system( $cmd );

    return $? >> 8;
}

my $pwd = `pwd` ; chomp $pwd;

runone( $just );

if ( scalar( @warnings ) )
{
    print "ERRORS:\n\n";

    foreach ( @warnings )
    {
        warn $_;
    }
}

exit 0;

sub runone
{
    my ($stem) = @_;

    print "##########################################################################\n";
    verbose_system( qq(cat $stem.silly) );

    my $thisflags = $flags;

    print "##########################################################################\n";
    my $source;
    if ( -e "$stem.sir" )
    {
        $source = "$stem.sir";
    }
    else
    {
        $source = "$stem.silly";
    }

    verbose_system("mkdir -p $outdir ; rm -f ${outdir}/${stem}.compile.out ${outdir}/${stem}.ll ${outdir}/${stem}.mlir ${outdir}/${stem}.o ${outdir}/${stem}.out ${outdir}/${stem}.s ${outdir}/${stem}.stderr.out ${outdir}/${stem}.dd");

    my $cmd = qq(${driverpath}/silly --output-directory $outdir $source $thisflags --emit-llvm --emit-mlir > ${outdir}/$stem.compile.out 2>&1);
    my $crc = verbose_system( $cmd );
    verbose_system("cat ${outdir}/$stem.compile.out");

    verbose_system( qq(objdump -dr --no-show-raw-insn ${outdir}/${stem}.o > ${outdir}/${stem}.s) );

    if ( $assembly )
    {
        verbose_system( qq(cat ${outdir}/${stem}.s) );
    }

    my $rc;
    my $exe = "${outdir}/${stem}";
    unless ( $exe =~ m,^[/\.], )
    {
        $exe = "./$exe";
    }

    $rc = verbose_system( qq(${exe} > ${outdir}/${stem}.out 2>${outdir}/${stem}.stderr.out) );
    verbose_system( qq(echo 'stdout:' ; cat ${outdir}/${stem}.out) );
    verbose_system( qq(echo 'stderr:' ; cat ${outdir}/${stem}.stderr.out) );

    print "${stem}: returned: $rc\n\n\n\n\n";

    complain( "${stem}: expected 0, and got $rc" ) if ( $rc ne 0 );

    if ( -e "expected/${stem}.out" )
    {
        my $crc = verbose_system( qq(diff -wup expected/${stem}.out ${outdir}/${stem}.out) );
        complain( "ERROR: diff -wup expected/${stem}.out ${outdir}/${stem}.out: $crc\n") if ( $crc );
    }
    else
    {
        my $msg = "ERROR: COMPARE FILE NOT FOUND: expected/${stem}.out\n";
        push( @warnings, $msg );
    }

    if ( -e "expected/${stem}.stderr.out" )
    {
        my $crc = verbose_system( qq(diff -wup expected/${stem}.stderr.out ${outdir}/${stem}.stderr.out) );
        complain( "ERROR: diff -wup expected/${stem}.stderr.out ${outdir}/${stem}.stderr.out: $crc\n") if ( $crc );
    }

    print "${stem}: TEST WAS SUCCESSFUL\n"; # for ctest rule
}

sub complain
{
    my ($message) = @_;

    if ( $fatal )
    {
        die $message;
    }
    else
    {
        push( @warnings, $message );
    }
}

# vim: et ts=4 sw=4
